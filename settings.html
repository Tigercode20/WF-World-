<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฅุนุฏุงุฏุงุช - WF World</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">โก WF World</a>
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <ul class="navbar-menu">
                    <li><a href="index.html" class="navbar-link">ุงูุฑุฆูุณูุฉ</a></li>
                    <li><a href="client-registration.html" class="navbar-link">ุชุณุฌูู ุนููู</a></li>
                    <li><a href="sales.html" class="navbar-link">ุงููุจูุนุงุช</a></li>
                    <li><a href="clients-dashboard.html" class="navbar-link">ูุงุฆูุฉ ุงูุนููุงุก</a></li>
                    <li><a href="client-lookup.html" class="navbar-link">ุจุญุซ</a></li>
                    <li><a href="settings.html" class="navbar-link active">ุงูุฅุนุฏุงุฏุงุช</a></li>
                </ul>
                <button id="theme-toggle-btn" class="theme-toggle" onclick="toggleTheme()"
                    title="ุชุบููุฑ ุงููุธูุฑ">โ๏ธ</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: 2rem 0; max-width: 800px;">
        <div class="card">
            <h1>โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุธุงู</h1>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                ุชูููู ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู ูุงูุฑุจุท ูุน ุงูุฎุฏูุงุช ุงูุฎุงุฑุฌูุฉ
            </p>

            <form id="settings-form">
                <!-- Google Sheets API -->
                <div class="settings-section" style="margin-bottom: 2rem;">
                    <h3 style="border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 1.5rem;">
                        ๐ ุฑุจุท Google Sheets
                    </h3>

                    <div class="alert alert-info"
                        style="background: rgba(66, 153, 225, 0.1); border-left: 4px solid var(--primary); margin-bottom: 1.5rem;">
                        <p style="margin: 0;">
                            <strong>ููุงุญุธุฉ ูุงูุฉ:</strong> ูุชูุนูู ุงููุฒุงููุฉ ูุน Google Formsุ ูุฌุจ ุนููู ุฅูุดุงุก Google Apps
                            Script
                            ูุฑุจุทู ุจููู ุงูุฅูุณูู ุงูุฎุงุต ุจุงูุฑุฏูุฏ.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="sheetsApiUrl" class="form-label">ุฑุงุจุท Google Apps Script (Web App URL)</label>
                        <input type="url" id="sheetsApiUrl" name="sheetsApiUrl" class="form-control"
                            placeholder="https://script.google.com/macros/s/..." dir="ltr">
                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                            ูู ุจูุตู ุฑุงุจุท ุงูู Web App ุงูุฐู ุญุตูุช ุนููู ุจุนุฏ ูุดุฑ ุงูุณูุฑุจุช.
                        </small>
                    </div>

                    <div class="d-flex align-items-center gap-2 mt-3">
                        <button type="button" id="test-api-btn" class="btn btn-outline" style="font-size: 0.9rem;">
                            ๐ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
                        </button>
                        <div id="api-status"></div>
                    </div>
                </div>

                <!-- Sync Settings -->
                <div class="settings-section" style="margin-bottom: 2rem;">
                    <h3 style="border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 1.5rem;">
                        ๐ ุฅุนุฏุงุฏุงุช ุงููุฒุงููุฉ
                    </h3>

                    <div class="form-check" style="display: flex; align-items: center; gap: 0.75rem;">
                        <input type="checkbox" id="autoSync" name="autoSync" style="width: 1.25rem; height: 1.25rem;">
                        <label for="autoSync" style="cursor: pointer;">ุชูุนูู ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ุนูุฏ ูุชุญ ุงูุชุทุจูู</label>
                    </div>
                </div>

                <!-- Data Migration -->
                <div class="settings-section" style="margin-bottom: 2rem;">
                    <h3 style="border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 1.5rem;">
                        โ๏ธ ุชุฑุญูู ุงูุจูุงูุงุช
                    </h3>
                    <p class="text-muted">
                        ุฅุฐุง ูุงู ูุฏูู ุจูุงูุงุช ูุฏููุฉ ูุญููุธุฉ ุนูู ูุฐุง ุงูุฌูุงุฒุ ููููู ููููุง ุฅูู ุงูุณุญุงุจุฉ.
                    </p>
                    <button type="button" id="migrate-btn" class="btn btn-primary" onclick="migrateLocalData()">
                        ๐ค ุฑูุน ุงูุจูุงูุงุช ุงููุญููุฉ ุฅูู ุงูุณุญุงุจุฉ
                    </button>
                    <div id="migration-status" style="margin-top: 5px;"></div>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-2"
                    style="margin-top: 3rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                    <button type="button" id="save-settings-btn" class="btn btn-primary">
                        ๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                    </button>
                    <button type="button" id="reset-btn" class="btn btn-outline">
                        โ ุฅูุบุงุก
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Config & DB -->
    <script src="js/firebase-config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // No need for async load check since scripts are synchronous now (unless defer/async used)
        async function loadSettings() {
            // ...

            try {
                const currentSettings = await window.db.getSettings();
                document.getElementById('sheetsApiUrl').value = currentSettings.sheetsApiUrl || '';
                document.getElementById('autoSync').checked = currentSettings.autoSync === true;
            } catch (e) {
                console.error("Failed to load settings", e);
                // Don't alert immediately on load, might be first run
            }
        }

        // Save settings handler
        document.getElementById('save-settings-btn').addEventListener('click', async function () {
            const sheetsApiUrl = document.getElementById('sheetsApiUrl').value.trim();
            const saveBtn = this;

            // Basic validation
            if (sheetsApiUrl && !sheetsApiUrl.startsWith('https://script.google.com/')) {
                showAlert('ุฑุงุจุท Google Sheets API ูุจุฏู ุบูุฑ ุตุญูุญ. ูุฌุจ ุฃู ูุจุฏุฃ ุจู https://script.google.com/', 'warning');
                return;
            }

            // Show saving state
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = 'โณ ุฌุงุฑู ุงูุญูุธ...';
            saveBtn.disabled = true;

            try {
                const autoSync = document.getElementById('autoSync').checked;
                
                // Update settings in Cloud DB
                await window.db.updateSettings({
                    sheetsApiUrl: sheetsApiUrl,
                    autoSync: autoSync
                });

                showAlert('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ! โ', 'success');

            } catch (error) {
                console.error('Save error:', error);
                showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ: ' + error.message, 'danger');
            } finally {
                // Restore button state
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }, 1000);
            }
        });

        // Test API Connection
        document.getElementById('test-api-btn').addEventListener('click', async function () {
            const url = document.getElementById('sheetsApiUrl').value.trim();
            const testBtn = this;

            if (!url) {
                showAlert('ูุฑุฌู ุฅุฏุฎุงู ุงูุฑุงุจุท ุฃููุงู ูุงุฎุชุจุงุฑู', 'warning');
                return;
            }

            testBtn.disabled = true;
            testBtn.innerHTML = 'โณ ุฌุงุฑู ุงูุงุฎุชุจุงุฑ...';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(response.statusText);

                const result = await response.json();

                if (result.status === 'success' || result.success === true) {
                    showAlert('ุชู ุงูุงุชุตุงู ุจูุฌุงุญ! ุงูุฑุงุจุท ูุนูู ุจุดูู ุตุญูุญ โ', 'success');
                } else {
                    showAlert('ุชู ุงูุงุชุตุงู ูููู ุงูุงุณุชุฌุงุจุฉ ุบูุฑ ูุชููุนุฉ. ุชุฃูุฏ ูู ุฅุนุฏุงุฏ ุงูุณูุฑุจุช โ๏ธ', 'warning');
                }

            } catch (error) {
                console.error('Test error:', error);
                showAlert('ูุดู ุงูุงุชุตุงู: ' + error.message + ' โ', 'danger');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '๐ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู';
            }
        });

        // Reset form
        document.getElementById('reset-btn').addEventListener('click', function () {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุบุงุก ุงูุชุบููุฑุงุช ุบูุฑ ุงููุญููุธุฉุ')) {
                loadSettings();
            }
        });

        // Migration Script (Local -> Cloud)
        window.migrateLocalData = function () {
            if (!confirm('ูู ุชุฑูุฏ ูุนูุงู ุฑูุน ุงูุจูุงูุงุช ุงููุญููุธุฉ ูุญููุงู (LocalStorage) ุฅูู ุงูุณุญุงุจุฉุ\n\nุชุฃูุฏ ูู ุนุฏู ุชูุฑุงุฑ ูุฐู ุงูุนูููุฉ.')) return;

            const migrateBtn = document.getElementById('migrate-btn');
            const statusDiv = document.getElementById('migration-status');

            migrateBtn.disabled = true;
            migrateBtn.innerText = "โณ ุฌุงุฑู ุงูุฑูุน...";

            try {
                // Read from LocalStorage directly (bypassing our new db.js which points to cloud)
                const DB_NAME = 'wf_world_db';
                const localStr = localStorage.getItem(DB_NAME);

                if (!localStr) {
                    throw new Error("ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุฉ ููุนุซูุฑ ุนูููุง.");
                }

                const localData = JSON.parse(localStr);
                const clients = localData.clients || [];

                if (clients.length === 0) {
                    throw new Error("ูุง ููุฌุฏ ุนููุงุก ูู ุงูุจูุงูุงุช ุงููุญููุฉ.");
                }

                let successCount = 0;
                let failCount = 0;

                // Process upload
                // We use window.db which is now the Cloud DB
                const uploadPromises = clients.map(async (client) => {
                    try {
                        // Check if exists first to avoid dupes? 
                        // For simplicity, we just try to add. db.addClient has check logic but strictly checks by Code in some versions.
                        // Our new db.addClient checks by code.
                        await window.db.addClient(client);
                        successCount++;
                    } catch (e) {
                        console.error("Failed to migrate client", client.clientCode, e);
                        failCount++;
                    }
                });

                Promise.all(uploadPromises).then(() => {
                    statusDiv.innerHTML = `<span style="color: green">โ ุชู ุฑูุน ${successCount} ุนููู. (ูุดู ${failCount})</span>`;
                    showAlert(`ุชู ุงูุงูุชูุงุก! ุชู ุฑูุน ${successCount} ุนููู ุฅูู ุงูุณุญุงุจุฉ.`, 'success');
                    migrateBtn.innerText = "โ ุชู ุงูุฑูุน";
                    // Optional: Backup and clear local? No, keep for safety.
                });

            } catch (e) {
                console.error(e);
                statusDiv.innerHTML = `<span style="color: red">โ ุฎุทุฃ: ${e.message}</span>`;
                showAlert(e.message, 'danger');
                migrateBtn.disabled = false;
                migrateBtn.innerText = "๐ค ุฑูุน ุงูุจูุงูุงุช ุงููุญููุฉ ุฅูู ุงูุณุญุงุจุฉ";
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>

</html>