<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل عميل جديد - WF World</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">⚡ WF World</a>
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <ul class="navbar-menu">
                    <li><a href="index.html" class="navbar-link">الرئيسية</a></li>
                    <li><a href="client-registration.html" class="navbar-link active">تسجيل عميل</a></li>
                    <li><a href="sales.html" class="navbar-link">المبيعات</a></li>
                    <li><a href="clients-dashboard.html" class="navbar-link">قائمة العملاء</a></li>
                    <li><a href="client-lookup.html" class="navbar-link">بحث</a></li>
                    <li><a href="settings.html" class="navbar-link">الإعدادات</a></li>
                </ul>
                <button id="theme-toggle-btn" class="theme-toggle" onclick="toggleTheme()"
                    title="تغيير المظهر">☀️</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: 2rem 0; max-width: 800px;">
        <div class="card">
            <h1>👤 تسجيل عميل جديد</h1>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                أدخل بيانات العميل الجديد لإنشاء ملف شخصي له في النظام
            </p>

            <!-- Google Forms Link Section -->
            <div class="alert alert-info"
                style="background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(72, 187, 120, 0.1)); border: 2px solid rgba(66, 153, 225, 0.3); margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <span style="font-size: 2rem;">📋</span>
                    <div>
                        <strong style="font-size: 1.1rem;">نموذج تسجيل العميل</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text-muted); font-size: 0.9rem;">
                            يمكنك إرسال هذا الرابط للعميل لملء بياناته مباشرة
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                    <a href="https://forms.gle/mpqqC8hxmwj35X6X8" target="_blank" class="btn btn-primary"
                        style="flex: 1; min-width: 200px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <span>🔗</span>
                        <span>فتح نموذج التسجيل</span>
                    </a>

                    <button type="button" id="copy-form-link-btn" class="btn btn-outline" onclick="copyFormLink()"
                        style="min-width: 150px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <span id="copy-icon">📋</span>
                        <span id="copy-text">نسخ الرابط</span>
                    </button>
                </div>

                <div
                    style="margin-top: 1rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.5); border-radius: 8px; word-break: break-all; font-size: 0.85rem; font-family: monospace; color: var(--text-secondary);">
                    https://forms.gle/mpqqC8hxmwj35X6X8
                </div>

                <!-- Sync Button -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(66, 153, 225, 0.2);">
                    <button type="button" id="sync-sheets-btn" class="btn btn-outline" onclick="syncFromSheets()"
                        style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 600;">
                        <span id="sync-icon">🔄</span>
                        <span id="sync-text">مزامنة العملاء من Google Sheets</span>
                    </button>

                    <div id="sync-status"
                        style="margin-top: 0.75rem; font-size: 0.85rem; text-align: center; color: var(--text-muted);">
                        <!-- Sync status will appear here -->
                    </div>
                </div>
            </div>

            <form id="client-form">
                <!-- Full Name -->
                <div class="form-group">
                    <label for="fullName" class="form-label">الاسم الكامل *</label>
                    <input type="text" id="fullName" name="fullName" class="form-control"
                        placeholder="أدخل الاسم الكامل" required>
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label for="email" class="form-label">البريد الإلكتروني *</label>
                    <input type="email" id="email" name="email" class="form-control" placeholder="example@email.com"
                        required>
                </div>

                <!-- Phone -->
                <div class="form-group">
                    <label for="phone" class="form-label">رقم الهاتف *</label>
                    <input type="tel" id="phone" name="phone" class="form-control" placeholder="+20 123 456 7890"
                        required>
                </div>

                <!-- Country -->
                <div class="form-group">
                    <label for="country" class="form-label">الدولة *</label>
                    <select id="country" name="country" class="form-control" required>
                        <option value="">-- اختر الدولة --</option>
                        <option value="مصر">مصر</option>
                        <option value="السعودية">السعودية</option>
                        <option value="الإمارات">الإمارات</option>
                        <option value="الكويت">الكويت</option>
                        <option value="قطر">قطر</option>
                        <option value="البحرين">البحرين</option>
                        <option value="الأردن">الأردن</option>
                        <option value="لبنان">لبنان</option>
                        <option value="العراق">العراق</option>
                        <option value="فلسطين">فلسطين</option>
                        <option value="سوريا">سوريا</option>
                        <option value="ليبيا">ليبيا</option>
                        <option value="تونس">تونس</option>
                        <option value="الجزائر">الجزائر</option>
                        <option value="المغرب">المغرب</option>
                        <option value="اليمن">اليمن</option>
                        <option value="عُمان">عُمان</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>

                <!-- Religion -->
                <div class="form-group">
                    <label for="religion" class="form-label">الديانة (اختياري)</label>
                    <select id="religion" name="religion" class="form-control">
                        <option value="">-- اختر --</option>
                        <option value="مسلم">مسلم</option>
                        <option value="مسيحي">مسيحي</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                    <small style="color: var(--text-muted); font-size: 0.85rem;">
                        يُستخدم لمراعاة فترات الصيام في الخطط الغذائية
                    </small>
                </div>

                <!-- Client Code Preview -->
                <div class="alert alert-info" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.25rem;">🎫</span>
                    <div>
                        <strong>كود العميل سيتم توليده تلقائياً</strong><br>
                        <small>سيتم إنشاء رقم تعريفي فريد للعميل بعد التسجيل</small>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-2" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">
                        ✅ تسجيل العميل
                    </button>
                    <button type="reset" class="btn btn-outline">
                        🔄 مسح الحقول
                    </button>
                    <a href="index.html" class="btn btn-outline">
                        ↩️ العودة للرئيسية
                    </a>
                </div>
            </form>
        </div>

        <!-- Recent Clients -->
        <div class="card mt-4">
            <h3>👥 آخر العملاء المسجلين</h3>
            <div id="recent-clients" style="margin-top: 1rem;">
                <!-- Will be loaded dynamically -->
                <div style="text-align: center; color: var(--text-muted); padding: 1rem;">
                    ⏳ جاري تحميل البيانات...
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Config & DB -->
    <script src="js/firebase-config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // Form submission handler
        document.getElementById('client-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!window.db) {
                showAlert('يرجى الانتظار حتى يتم تحميل قاعدة البيانات', 'info');
                return;
            }

            // Get form data
            const formData = new FormData(this);
            const clientData = {
                fullName: formData.get('fullName').trim(),
                email: formData.get('email').trim(),
                phone: formData.get('phone').trim(),
                country: formData.get('country'),
                religion: formData.get('religion')
            };

            // Validate
            if (!clientData.fullName || !clientData.email || !clientData.phone || !clientData.country) {
                showAlert('يرجى ملء جميع الحقول المطلوبة', 'warning');
                return;
            }

            if (!isValidEmail(clientData.email)) {
                showAlert('البريد الإلكتروني غير صحيح', 'danger');
                return;
            }

            if (!isValidPhone(clientData.phone)) {
                showAlert('رقم الهاتف غير صحيح', 'danger');
                return;
            }

            // Show loading
            showLoading('جاري تسجيل العميل...');

            try {
                // Add client to database (Async call)
                const newClient = await window.db.addClient(clientData);

                hideLoading();
                showAlert(`تم تسجيل العميل بنجاح! كود العميل: ${newClient.clientCode}`, 'success');

                // Reset form
                this.reset();

                // Reload recent clients
                await loadRecentClients();

            } catch (error) {
                hideLoading();
                console.error(error);
                showAlert('حدث خطأ أثناء التسجيل: ' + error.message, 'danger');
            }
        });

        // Load recent clients
        async function loadRecentClients() {
            if (!window.db) {
                // Retry if db not ready
                setTimeout(loadRecentClients, 500);
                return;
            }

            const container = document.getElementById('recent-clients');

            try {
                const clients = await window.db.getAllClients();

                if (clients.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">لم يتم تسجيل أي عملاء بعد</p>';
                    return;
                }

                // Sort by date (newest first)
                const recentClients = clients
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 5);

                container.innerHTML = recentClients.map(client => `
                    <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-md); margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                        <strong>${client.fullName}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                            ${client.email} • ${client.phone}
                        </div>
                        </div>
                        <div style="text-align: left;">
                        <span class="badge badge-primary">${client.clientCode}</span>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                            ${formatDate(client.registrationDate || client.createdAt)}
                        </div>
                        </div>
                    </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Error loading recent clients:", e);
                container.innerHTML = '<p style="color: var(--danger);">فشل تحميل البيانات</p>';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', loadRecentClients);

        // Copy Google Form link to clipboard
        function copyFormLink() {
            const formLink = 'https://forms.gle/mpqqC8hxmwj35X6X8';

            // Copy to clipboard
            navigator.clipboard.writeText(formLink).then(() => {
                // Update button appearance
                const copyIcon = document.getElementById('copy-icon');
                const copyText = document.getElementById('copy-text');
                const copyBtn = document.getElementById('copy-form-link-btn');

                // Change to success state
                copyIcon.textContent = '✅';
                copyText.textContent = 'تم النسخ!';
                copyBtn.style.background = 'linear-gradient(135deg, rgba(72, 187, 120, 0.2), rgba(56, 161, 105, 0.2))';
                copyBtn.style.borderColor = 'var(--success)';
                copyBtn.style.color = 'var(--success)';

                // Show success alert
                showAlert('تم نسخ رابط النموذج بنجاح! يمكنك الآن إرساله للعميل', 'success');

                // Reset after 3 seconds
                setTimeout(() => {
                    copyIcon.textContent = '📋';
                    copyText.textContent = 'نسخ الرابط';
                    copyBtn.style.background = '';
                    copyBtn.style.borderColor = '';
                    copyBtn.style.color = '';
                }, 3000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showAlert('فشل نسخ الرابط. يرجى المحاولة مرة أخرى', 'danger');
            });
        }

        // Sync clients from Google Sheets
        async function syncFromSheets() {
            if (!window.db) {
                showAlert('جار تحميل النظام...', 'info');
                return;
            }

            const syncBtn = document.getElementById('sync-sheets-btn');
            const syncIcon = document.getElementById('sync-icon');
            const syncText = document.getElementById('sync-text');
            const syncStatus = document.getElementById('sync-status');

            // Disable button and show loading state
            syncBtn.disabled = true;
            syncIcon.textContent = '⏳';
            syncText.textContent = 'جاري المزامنة...';
            syncStatus.innerHTML = '<span style="color: var(--text-secondary);">⏳ جاري الاتصال بـ Google Sheets...</span>';

            try {
                // Call the sync function from database
                const result = await window.db.syncFromGoogleSheets();

                if (result.success) {
                    // Update button to success state
                    syncIcon.textContent = '✅';
                    syncText.textContent = 'تمت المزامنة!';
                    syncBtn.style.background = 'linear-gradient(135deg, rgba(72, 187, 120, 0.2), rgba(56, 161, 105, 0.2))';
                    syncBtn.style.borderColor = 'var(--success)';
                    syncBtn.style.color = 'var(--success)';

                    // Show detailed status
                    syncStatus.innerHTML = `
                        <div style="color: var(--success); font-weight: 600;">
                            ✅ ${result.message}
                        </div>
                        <div style="margin-top: 0.5rem; color: var(--text-muted);">
                            📊 إجمالي: ${result.total} | 
                            ➕ جديد: ${result.added} | 
                            🔄 محدّث: ${result.updated} | 
                            ⏭️ متخطى: ${result.skipped}
                        </div>
                        ${result.skipped > 0 && result.skippedReasons ? `
                        <div style="margin-top: 0.5rem; text-align: right; background: rgba(0,0,0,0.05); padding: 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                            <strong>⚠️ تفاصيل التخطي:</strong>
                            <ul style="margin: 0; padding-right: 1.2rem; color: var(--danger);">
                                ${result.skippedReasons.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>` : ''}
                    `;

                    // Show success alert
                    showAlert(result.message, 'success');

                    // Reload recent clients list
                    await loadRecentClients();

                    // Reset button after 5 seconds
                    setTimeout(() => {
                        syncIcon.textContent = '🔄';
                        syncText.textContent = 'مزامنة العملاء من Google Sheets';
                        syncBtn.style.background = '';
                        syncBtn.style.borderColor = '';
                        syncBtn.style.color = '';
                        syncBtn.disabled = false;
                    }, 5000);
                } else {
                    throw new Error(result.message || 'فشلت المزامنة');
                }

            } catch (error) {
                console.error('Sync error:', error);

                // Update button to error state
                syncIcon.textContent = '❌';
                syncText.textContent = 'فشلت المزامنة';
                syncBtn.style.background = 'linear-gradient(135deg, rgba(229, 62, 62, 0.2), rgba(197, 48, 48, 0.2))';
                syncBtn.style.borderColor = 'var(--danger)';
                syncBtn.style.color = 'var(--danger)';

                // Show error status
                syncStatus.innerHTML = `
                    <div style="color: var(--danger); font-weight: 600;">
                        ❌ ${error.message}
                    </div>
                    <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">
                        💡 تأكد من صحة رابط Google Sheets API في الإعدادات
                    </div>
                `;

                // Show error alert
                showAlert('فشلت المزامنة: ' + error.message, 'danger');

                // Reset button after 5 seconds
                setTimeout(() => {
                    syncIcon.textContent = '🔄';
                    syncText.textContent = 'مزامنة العملاء من Google Sheets';
                    syncBtn.style.background = '';
                    syncBtn.style.borderColor = '';
                    syncBtn.style.color = '';
                    syncBtn.disabled = false;
                    syncStatus.innerHTML = '';
                }, 5000);
            }
        }

        // Display last sync info on load
        document.addEventListener('DOMContentLoaded', function () {
            // Check for last sync info asynchronously
            const checkSync = async () => {
                if (!window.db) {
                    setTimeout(checkSync, 1000);
                    return;
                }

                try {
                    const settings = await window.db.getSettings();
                    const syncStatus = document.getElementById('sync-status');

                    if (settings.lastSyncDate && syncStatus) {
                        const lastSync = new Date(settings.lastSyncDate);
                        const now = new Date();
                        const diffMinutes = Math.floor((now - lastSync) / (1000 * 60));

                        let timeAgo;
                        if (diffMinutes < 1) {
                            timeAgo = 'منذ لحظات';
                        } else if (diffMinutes < 60) {
                            timeAgo = `منذ ${diffMinutes} دقيقة`;
                        } else if (diffMinutes < 1440) {
                            timeAgo = `منذ ${Math.floor(diffMinutes / 60)} ساعة`;
                        } else {
                            timeAgo = `منذ ${Math.floor(diffMinutes / 1440)} يوم`;
                        }

                        // Only set if still empty
                        if (syncStatus.innerHTML.trim() === '') {
                            syncStatus.innerHTML = `<span style="color: var(--text-muted); font-size: 0.8rem;">⏰ آخر مزامنة: ${timeAgo}</span>`;
                        }
                    }
                } catch (e) {
                    console.log("No sync info yet");
                }
            };

            checkSync();
        });
    </script>
</body>

</html>