<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel - WF World</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">âš¡ WF World</a>
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <ul class="navbar-menu">
                    <li><a href="index.html" class="navbar-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li><a href="client-registration.html" class="navbar-link">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„</a></li>
                    <li><a href="sales.html" class="navbar-link">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a></li>
                    <li><a href="clients-dashboard.html" class="navbar-link">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
                    <li><a href="client-lookup.html" class="navbar-link">Ø¨Ø­Ø«</a></li>
                </ul>
                <button id="theme-toggle-btn" class="theme-toggle" onclick="toggleTheme()"
                    title="ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¸Ù‡Ø±">â˜€ï¸</button>
            </div>
        </div>
    </nav>

    <main class="container" style="padding: 2rem 0; max-width: 900px;">
        <div class="card">
            <h1>ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel</h1>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                Ø§Ø³ØªÙˆØ±Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø®Ø·Ø· Ù…Ù† Ù…Ù„Ù Excel
            </p>

            <!-- File Upload -->
            <div class="form-group">
                <label for="excel-file" class="form-label">Ø§Ø®ØªØ± Ù…Ù„Ù Excel (WF World.xlsx)</label>
                <input type="file" id="excel-file" accept=".xlsx,.xls" class="form-control" style="padding: 1rem;">
            </div>

            <!-- Import Options -->
            <div class="form-group">
                <label class="form-label">Ù…Ø§ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡:</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="import-clients" checked style="cursor: pointer;">
                        <span>ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Client_Registration)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="import-sales" checked style="cursor: pointer;">
                        <span>ğŸ’³ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Sales)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="import-updates" checked style="cursor: pointer;">
                        <span>ğŸ“Š Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª (Update - Diet / Workout)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="import-plans" checked style="cursor: pointer;">
                        <span>ğŸ“‹ Ø§Ù„Ø®Ø·Ø· (ST_Plan)</span>
                    </label>
                </div>
            </div>

            <!-- Preview Section -->
            <div id="preview-section" style="display: none; margin-top: 2rem;">
                <h3>ğŸ“Š Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <div id="preview-content" style="margin-top: 1rem;"></div>
            </div>

            <!-- Import Summary -->
            <div id="import-summary" style="display: none; margin-top: 2rem;"></div>

            <!-- Buttons -->
            <div class="d-flex gap-2" style="margin-top: 2rem;">
                <button id="btn-import" class="btn btn-primary" onclick="importData()" disabled>
                    ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="btn btn-outline" onclick="clearPreview()">
                    ğŸ”„ Ù…Ø³Ø­
                </button>
                <a href="index.html" class="btn btn-outline">
                    â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
            </div>
        </div>
    </main>

    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script>
        let excelData = null;

        // File upload handler
        document.getElementById('excel-file').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            showLoading('Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel...');

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    excelData = {
                        clients: [],
                        sales: [],
                        updates: [],
                        plans: []
                    };

                    // Read Client_Registration sheet (English or Arabic)
                    let clientSheet = null;
                    if (workbook.SheetNames.includes('Client_Registration')) {
                        clientSheet = workbook.Sheets['Client_Registration'];
                    } else if (workbook.SheetNames.includes('Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡')) {
                        clientSheet = workbook.Sheets['Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡'];
                    } else if (workbook.SheetNames.includes('ÙÙˆØ±Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡')) {
                        clientSheet = workbook.Sheets['ÙÙˆØ±Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡'];
                    }
                    if (clientSheet) {
                        const rows = XLSX.utils.sheet_to_json(clientSheet);
                        excelData.clients = rows;
                    }

                    // Read Sales sheet (English or Arabic)
                    let salesSheet = null;
                    if (workbook.SheetNames.includes('Sales')) {
                        salesSheet = workbook.Sheets['Sales'];
                    } else if (workbook.SheetNames.includes('Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª')) {
                        salesSheet = workbook.Sheets['Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª'];
                    }
                    if (salesSheet) {
                        const rows = XLSX.utils.sheet_to_json(salesSheet);
                        excelData.sales = rows;
                    }

                    // Read Update sheet (English or Arabic)
                    let updateSheet = null;
                    if (workbook.SheetNames.includes('Update - Diet / Workout')) {
                        updateSheet = workbook.Sheets['Update - Diet / Workout'];
                    } else if (workbook.SheetNames.includes(' Update - Diet  Workout ')) {
                        updateSheet = workbook.Sheets[' Update - Diet  Workout '];
                    } else if (workbook.SheetNames.includes('Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª')) {
                        updateSheet = workbook.Sheets['Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª'];
                    } else if (workbook.SheetNames.includes('ÙÙˆØ±Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«')) {
                        updateSheet = workbook.Sheets['ÙÙˆØ±Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«'];
                    }
                    if (updateSheet) {
                        const rows = XLSX.utils.sheet_to_json(updateSheet);
                        excelData.updates = rows;
                    }

                    // Read ST_Plan sheet (English or Arabic)
                    let planSheet = null;
                    if (workbook.SheetNames.includes('ST_Plan')) {
                        planSheet = workbook.Sheets['ST_Plan'];
                    } else if (workbook.SheetNames.includes('Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ø£ÙˆÙ„Ù‰')) {
                        planSheet = workbook.Sheets['Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ø£ÙˆÙ„Ù‰'];
                    } else if (workbook.SheetNames.includes('ÙÙˆØ±Ù… Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰')) {
                        planSheet = workbook.Sheets['ÙÙˆØ±Ù… Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰'];
                    }
                    if (planSheet) {
                        const rows = XLSX.utils.sheet_to_json(planSheet);
                        excelData.plans = rows;
                    }

                    hideLoading();
                    showPreview();
                    document.getElementById('btn-import').disabled = false;

                } catch (error) {
                    hideLoading();
                    showAlert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message, 'danger');
                }
            };

            reader.readAsArrayBuffer(file);
        });

        // Show preview
        function showPreview() {
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');

            let html = '<div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">';

            html += `
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-value">${excelData.clients.length}</div>
          <div class="stat-label">Ø¹Ù…ÙŠÙ„</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’³</div>
          <div class="stat-value">${excelData.sales.length}</div>
          <div class="stat-label">Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-value">${excelData.updates.length}</div>
          <div class="stat-label">ØªØ­Ø¯ÙŠØ«</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“‹</div>
          <div class="stat-value">${excelData.plans.length}</div>
          <div class="stat-label">Ø®Ø·Ø©</div>
        </div>
      `;

            html += '</div>';

            // Show sample client data
            if (excelData.clients.length > 0) {
                html += '<div style="margin-top: 1.5rem;"><strong>Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</strong>';
                html += '<ul style="margin-top: 0.5rem;">';
                excelData.clients.slice(0, 5).forEach(client => {
                    html += `<li>${client['Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ'] || client['Full Name'] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} - ${client['Email Address'] || ''}</li>`;
                });
                html += '</ul></div>';
            }

            previewContent.innerHTML = html;
            previewSection.style.display = 'block';
        }

        // Import data
        function importData() {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

            let imported = {
                clients: 0,
                sales: 0,
                updates: 0,
                plans: 0
            };

            setTimeout(() => {
                try {
                    // Import clients
                    if (document.getElementById('import-clients').checked) {
                        excelData.clients.forEach(row => {
                            try {
                                const clientData = {
                                    fullName: row['Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ'] || row['Ø§Ù„Ø§Ø³Ù…'] || row['Full Name'] || '',
                                    email: row['Email Address'] || row['Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„'] || row['Email'] || '',
                                    phone: row['Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†'] || row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || row['Phone Number'] || '',
                                    country: row['Ø§Ù„Ø¯ÙˆÙ„Ø©'] || row['Country'] || '',
                                    religion: row['Ø§Ù„Ø¯ÙŠØ§Ù†Ø©\nÙ„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„ØµÙŠØ§Ù… '] || row['Ø§Ù„Ø¯ÙŠØ§Ù†Ø©'] || row['Religion'] || '',
                                    registrationDate: row['Timestamp'] || new Date().toISOString()
                                };

                                // Extract clientCode from 'Ø§Ù„ÙƒÙˆØ¯' column
                                if (row['Ø§Ù„ÙƒÙˆØ¯']) {
                                    clientData.clientCode = row['Ø§Ù„ÙƒÙˆØ¯'].toString().trim();
                                }

                                if (clientData.fullName && clientData.email) {
                                    db.addClient(clientData);
                                    imported.clients++;
                                }
                            } catch (e) {
                                console.error('Error importing client:', e);
                            }
                        });
                    }

                    // Import sales/subscriptions
                    if (document.getElementById('import-sales').checked) {
                        excelData.sales.forEach(row => {
                            try {
                                const clientCode = row['Client Code ğŸ“”'] || row['Client Code'] || row['ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„'] || '';
                                const packageName = row['ğŸ“¦ Package\n'] || row['Package'] || row['Ø§Ù„Ø¨Ø§Ù‚Ø©'] || '';
                                const amount = parseFloat(row['ğŸ’µ Amount Paid'] || row['Amount'] || row['Ø§Ù„Ù…Ø¨Ù„Øº'] || 0);
                                const currency = row['ğŸ’² Currency'] || row['Currency'] || row['Ø§Ù„Ø¹Ù…Ù„Ø©'] || 'EGP';
                                const paymentMethod = row['ğŸ’³ Receive Account'] || row['Payment Method'] || row['Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'] || '';
                                const startDate = row['ğŸ“… Start Date'] || row['Start Date'] || row['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡'] || new Date().toISOString();

                                // Determine subscription type
                                const typeRaw = row['ğŸš§ Subscription Type\n'] || row['Type'] || row['Ø§Ù„Ù†ÙˆØ¹'] || 'new';
                                const type = typeRaw && typeRaw.toString().toLowerCase().includes('renew') ? 'renewal' : 'new';

                                if (clientCode && packageName && amount) {
                                    // Check if client exists
                                    const client = db.getClient(clientCode);
                                    if (client) {
                                        const subscriptionData = {
                                            clientCode: clientCode,
                                            type: type,
                                            package: packageName,
                                            amount: amount,
                                            currency: currency,
                                            paymentMethod: paymentMethod,
                                            startDate: startDate
                                        };

                                        db.addSubscription(subscriptionData);
                                        imported.sales++;
                                    } else {
                                        console.warn(`Client ${clientCode} not found for subscription`);
                                    }
                                }
                            } catch (e) {
                                console.error('Error importing sale:', e);
                            }
                        });
                    }

                    // Import updates
                    if (document.getElementById('import-updates').checked) {
                        excelData.updates.forEach(row => {
                            try {
                                const clientCode = row['Client Code'] || row['ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„'] || '';
                                const compliance = parseInt(row['Compliance %'] || row['Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…'] || 80);

                                if (clientCode) {
                                    const updateData = {
                                        clientCode: clientCode,
                                        compliancePercentage: compliance,
                                        dietFeedback: row['Diet Feedback'] || row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ'] || '',
                                        workoutFeedback: row['Workout Feedback'] || row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨'] || '',
                                        currentStatus: row['Current Status'] || row['Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©'] || ''
                                    };

                                    db.addUpdate(updateData);
                                    imported.updates++;
                                }
                            } catch (e) {
                                console.error('Error importing update:', e);
                            }
                        });
                    }

                    // Import plans
                    if (document.getElementById('import-plans').checked) {
                        excelData.plans.forEach(row => {
                            try {
                                const clientCode = row['Client Code'] || row['ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„'] || '';
                                const duration = parseInt(row['Duration'] || row['Ø§Ù„Ù…Ø¯Ø©'] || 30);

                                if (clientCode) {
                                    const planData = {
                                        clientCode: clientCode,
                                        duration: duration,
                                        dietPlan: {
                                            goal: row['Diet Goal'] || row['Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØºØ°Ø§Ø¦ÙŠ'] || '',
                                            calories: parseInt(row['Calories'] || row['Ø§Ù„Ø³Ø¹Ø±Ø§Øª'] || 0) || null,
                                            protein: parseInt(row['Protein'] || row['Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†'] || 0) || null,
                                            carbs: parseInt(row['Carbs'] || row['Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª'] || 0) || null,
                                            fats: parseInt(row['Fats'] || row['Ø§Ù„Ø¯Ù‡ÙˆÙ†'] || 0) || null,
                                            notes: row['Diet Notes'] || row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ°Ø§Ø¦ÙŠ'] || ''
                                        },
                                        workoutPlan: {
                                            goal: row['Workout Goal'] || row['Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ'] || '',
                                            daysPerWeek: parseInt(row['Days/Week'] || row['Ø§Ù„Ø£ÙŠØ§Ù…'] || 0) || null,
                                            sessionDuration: parseInt(row['Duration/Session'] || row['Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©'] || 0) || null,
                                            location: row['Location'] || row['Ø§Ù„Ù…ÙƒØ§Ù†'] || '',
                                            notes: row['Workout Notes'] || row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨'] || ''
                                        },
                                        notes: row['General Notes'] || row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©'] || ''
                                    };

                                    db.addPlan(planData);
                                    imported.plans++;
                                }
                            } catch (e) {
                                console.error('Error importing plan:', e);
                            }
                        });
                    }

                    hideLoading();

                    // Show summary
                    let summaryHtml = '<div class="alert alert-success">';
                    summaryHtml += '<h3 style="margin-top: 0;">âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!</h3>';
                    summaryHtml += '<ul style="margin: 1rem 0 0 0;">';
                    summaryHtml += `<li>ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ <strong>${imported.clients}</strong> Ø¹Ù…ÙŠÙ„</li>`;
                    summaryHtml += `<li>ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ <strong>${imported.sales}</strong> Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹</li>`;
                    summaryHtml += `<li>ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ <strong>${imported.updates}</strong> ØªØ­Ø¯ÙŠØ«</li>`;
                    summaryHtml += `<li>ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ <strong>${imported.plans}</strong> Ø®Ø·Ø©</li>`;
                    summaryHtml += '</ul>';
                    summaryHtml += '<a href="clients-dashboard.html" class="btn btn-primary" style="margin-top: 1rem;">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a>';
                    summaryHtml += '</div>';

                    document.getElementById('import-summary').innerHTML = summaryHtml;
                    document.getElementById('import-summary').style.display = 'block';

                } catch (error) {
                    hideLoading();
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + error.message, 'danger');
                }
            }, 500);
        }

        function clearPreview() {
            document.getElementById('excel-file').value = '';
            document.getElementById('preview-section').style.display = 'none';
            document.getElementById('import-summary').style.display = 'none';
            document.getElementById('btn-import').disabled = true;
            excelData = null;
        }
    </script>
</body>

</html>