<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قائمة العملاء - WF World</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">⚡ WF World</a>
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <ul class="navbar-menu">
                    <li><a href="index.html" class="navbar-link">الرئيسية</a></li>
                    <li><a href="client-registration.html" class="navbar-link">تسجيل عميل</a></li>
                    <li><a href="sales.html" class="navbar-link">المبيعات</a></li>
                    <li><a href="clients-dashboard.html" class="navbar-link active">قائمة العملاء</a></li>
                    <li><a href="client-lookup.html" class="navbar-link">بحث</a></li>
                    <li><a href="settings.html" class="navbar-link">الإعدادات</a></li>
                </ul>
                <button id="theme-toggle-btn" class="theme-toggle" onclick="toggleTheme()"
                    title="تغيير المظهر">☀️</button>
            </div>
        </div>
    </nav>

    <main class="container" style="padding: 2rem 0;">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h1>👥 قائمة العملاء</h1>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="exportClientsToCSV()" class="btn btn-outline" id="export-btn">
                        📥 تصدير CSV
                    </button>
                    <!-- Clear data is risky in cloud, maybe hide or protect heavily. For now, we adjust it -->
                </div>
            </div>

            <!-- Search Box -->
            <div class="form-group">
                <input type="text" id="search-box" class="form-control"
                    placeholder="🔍 ابحث بالاسم، البريد الإلكتروني، الهاتف، أو كود العميل...">
            </div>

            <!-- Clients Table -->
            <div class="table-container" style="margin-top: 1.5rem;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>الكود</th>
                            <th>الاسم</th>
                            <th>البريد الإلكتروني</th>
                            <th>الهاتف</th>
                            <th>الدولة</th>
                            <th>الحالة</th>
                            <th>تاريخ التسجيل</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body">
                        <tr>
                            <td colspan="8" style="text-align:center;">⏳ جاري تحميل العملاء...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="no-results" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
                لا توجد نتائج
            </div>
        </div>
    </main>

    <script src="js/confirm-modal.js"></script>
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="js/firebase-config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script>
        let allClients = [];

        async function loadClients() {
            if (!window.db) {
                setTimeout(loadClients, 500);
                return;
            }

            const tbody = document.getElementById('clients-table-body');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">⏳ جاري تحميل العملاء من السحابة...</td></tr>';

            try {
                allClients = await window.db.getAllClients();
                // Sort by createdAt desc
                allClients.sort((a, b) => new Date(b.createdAt || b.registrationDate) - new Date(a.createdAt || a.registrationDate));
                renderClients(allClients);
            } catch (e) {
                console.error("Error loading clients:", e);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">❌ فشل تحميل البيانات: ' + e.message + '</td></tr>';
            }
        }

        async function renderClients(clients) {
            const tbody = document.getElementById('clients-table-body');
            const noResults = document.getElementById('no-results');

            if (clients.length === 0) {
                tbody.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';

            // Get all subscriptions once
            let allSubs = [];
            try {
                allSubs = await window.db.getAllSubscriptions();
            } catch (e) {
                console.log('Could not load subscriptions for status check');
            }

            // Build client status map
            const now = new Date();
            const clientStatusMap = {};
            allSubs.forEach(sub => {
                const endDate = sub.endDate ? new Date(sub.endDate) : null;
                if (endDate && endDate > now) {
                    clientStatusMap[sub.clientCode] = 'active';
                }
            });

            tbody.innerHTML = clients.map(client => {
                const hasActiveSubscription = clientStatusMap[client.clientCode] === 'active';
                const statusBadge = hasActiveSubscription
                    ? '<span class="badge badge-success">نشط</span>'
                    : '<span class="badge" style="background: rgba(158, 158, 158, 0.2); color: #9e9e9e;">بدون اشتراك</span>';

                return `
              <tr>
                <td><strong>${client.clientCode}</strong></td>
                <td>${client.fullName}</td>
                <td>${client.email || '-'}</td>
                <td>${client.phone || '-'}</td>
                <td>${client.country || '-'}</td>
                <td>${statusBadge}</td> 
                <td>${formatDate(client.registrationDate)}</td>
                <td>
                  <div style="display: flex; gap: 0.25rem;">
                    <a href="client-lookup.html?code=${client.clientCode}" class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                      👁️ عرض
                    </a>
                    <button onclick="deleteClientConfirm('${client.clientCode}', '${client.fullName}')" class="btn btn-outline" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; background: rgba(244, 67, 54, 0.1); color: #f44336; border-color: #f44336;">
                      🗑️ حذف
                    </button>
                  </div>
                </td>
              </tr>
            `;
            }).join('');
        }

        // Search functionality
        document.getElementById('search-box').addEventListener('input', function (e) {
            const query = e.target.value.trim().toLowerCase();

            if (!query) {
                renderClients(allClients);
                return;
            }

            // Client-side search for now since we have allClients
            const filtered = allClients.filter(c =>
                (c.fullName && c.fullName.toLowerCase().includes(query)) ||
                (c.email && c.email.toLowerCase().includes(query)) ||
                (c.phone && c.phone.includes(query)) ||
                (c.clientCode && c.clientCode.toLowerCase().includes(query))
            );
            renderClients(filtered);
        });

        // Export to CSV
        window.exportClientsToCSV = function () {
            const data = allClients.map(client => ({
                'كود العميل': client.clientCode,
                'الاسم': client.fullName,
                'البريد': client.email,
                'الهاتف': client.phone,
                'الدولة': client.country,
                'الديانة': client.religion,
                'تاريخ التسجيل': formatDate(client.registrationDate)
            }));

            exportToCSV(data, `clients_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Delete client function
        window.deleteClientConfirm = function (clientCode, clientName) {
            const message = `هل أنت متأكد من حذف العميل "${clientName}"؟\n\nسيتم حذف:\n• بيانات العميل\n• جميع الاشتراكات\n• جميع الخطط\n• جميع التحديثات\n\nهذا الإجراء لا يمكن التراجع عنه!`;

            showCustomConfirm(message, async function () {
                showLoading('جاري الحذف...');
                try {
                    const result = await window.db.deleteClient(clientCode);
                    hideLoading();
                    if (result) {
                        showAlert(`تم حذف العميل "${clientName}" بنجاح`, 'success');
                        loadClients(); // Reload the table
                    }
                } catch (e) {
                    hideLoading();
                    showAlert('حدث خطأ أثناء الحذف: ' + e.message, 'danger');
                }
            });
        }

        // Removed clearAllDataConfirm for safety in cloud environment for now, 
        // or re-implement later with big warning.

        document.addEventListener('DOMContentLoaded', loadClients);
    </script>
</body>

</html>