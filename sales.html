<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل مبيعات - WF World</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">⚡ WF World</a>
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <ul class="navbar-menu">
                    <li><a href="index.html" class="navbar-link">الرئيسية</a></li>
                    <li><a href="client-registration.html" class="navbar-link">تسجيل عميل</a></li>
                    <li><a href="sales.html" class="navbar-link active">المبيعات</a></li>
                    <li><a href="clients-dashboard.html" class="navbar-link">قائمة العملاء</a></li>
                    <li><a href="client-lookup.html" class="navbar-link">بحث</a></li>
                    <li><a href="settings.html" class="navbar-link">الإعدادات</a></li>
                </ul>
            </div>
    </nav> <button id="theme-toggle-btn" class="theme-toggle" onclick="toggleTheme()" title="تغيير المظهر">☀️</button>
    </div>
    </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: 2rem 0; max-width: 800px;">
        <div class="card">
            <h1>💳 تسجيل اشتراك جديد</h1>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                سجّل اشتراك جديد أو تجديد لعميل موجود
            </p>

            <form id="sales-form">
                <!-- Subscription Type -->
                <div class="form-group">
                    <label for="type" class="form-label">نوع الاشتراك *</label>
                    <select id="type" name="type" class="form-control" required>
                        <option value="">-- اختر --</option>
                        <option value="new">اشتراك جديد</option>
                        <option value="renew">تجديد</option>
                    </select>
                </div>

                <!-- Client Selection -->
                <div class="form-group">
                    <label for="clientCode" class="form-label">العميل *</label>
                    <select id="clientCode" name="clientCode" class="form-control" required>
                        <option value="">-- اختر العميل --</option>
                    </select>
                    <small style="color: var(--text-muted); font-size: 0.85rem;">
                        لا تجد العميل؟ <a href="client-registration.html">سجّل عميل جديد</a>
                    </small>
                </div>

                <!-- Package -->
                <div class="form-group">
                    <label for="package" class="form-label">الباقة *</label>
                    <select id="package" name="package" class="form-control" required>
                        <option value="">-- اختر الباقة --</option>
                    </select>
                    <div id="package-info"
                        style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                        <!-- Package duration info will appear here -->
                    </div>
                </div>

                <!-- Amount -->
                <div class="form-group">
                    <label for="amount" class="form-label">المبلغ *</label>
                    <input type="number" id="amount" name="amount" class="form-control" placeholder="500" min="0"
                        step="0.01" required>
                </div>

                <!-- Currency -->
                <div class="form-group">
                    <label for="currency" class="form-label">العملة *</label>
                    <select id="currency" name="currency" class="form-control" required>
                        <option value="">-- اختر العملة --</option>
                    </select>
                </div>

                <!-- Payment Method -->
                <div class="form-group">
                    <label for="paymentMethod" class="form-label">طريقة الدفع *</label>
                    <select id="paymentMethod" name="paymentMethod" class="form-control" required>
                        <option value="">-- اختر طريقة الدفع --</option>
                    </select>
                </div>

                <!-- Auto-calculated info -->
                <div id="subscription-preview" class="alert alert-info" style="display: none;">
                    <strong>📅 معاينة الاشتراك</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                        <div id="preview-content"></div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-2" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">
                        ✅ تسجيل الاشتراك
                    </button>
                    <button type="reset" class="btn btn-outline">
                        🔄 مسح الحقول
                    </button>
                    <a href="index.html" class="btn btn-outline">
                        ↩️ العودة للرئيسية
                    </a>
                </div>
            </form>
        </div>

        <!-- Recent Sales -->
        <div class="card mt-4">
            <h3>💰 آخر المبيعات</h3>
            <div id="recent-sales" style="margin-top: 1rem;">
                <!-- Will be loaded dynamically -->
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadClients();
            loadPackages();
            loadCurrencies();
            loadPaymentMethods();
            loadRecentSales();
        });

        // Load clients into dropdown
        function loadClients() {
            const clients = db.getAllClients();
            const select = document.getElementById('clientCode');

            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.clientCode;
                option.textContent = `${client.fullName} (${client.clientCode})`;
                select.appendChild(option);
            });
        }

        // Load packages
        function loadPackages() {
            const settings = db.getSettings();
            const select = document.getElementById('package');

            settings.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.name;
                option.dataset.duration = pkg.duration;
                option.textContent = pkg.name;
                select.appendChild(option);
            });
        }

        // Load currencies
        function loadCurrencies() {
            const settings = db.getSettings();
            populateSelect(document.getElementById('currency'), settings.currencies);
        }

        // Load payment methods
        function loadPaymentMethods() {
            const settings = db.getSettings();
            populateSelect(document.getElementById('paymentMethod'), settings.paymentMethods);
        }

        // Show package info
        document.getElementById('package').addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            const duration = selected.dataset.duration;
            const info = document.getElementById('package-info');

            if (duration) {
                info.innerHTML = `⏱️ المدة: ${duration} يوم`;
                updatePreview();
            } else {
                info.innerHTML = '';
            }
        });

        // Update preview when fields change
        ['package', 'amount', 'currency'].forEach(id => {
            document.getElementById(id).addEventListener('change', updatePreview);
        });

        function updatePreview() {
            const packageSelect = document.getElementById('package');
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;

            if (packageSelect.value && amount && currency) {
                const selected = packageSelect.options[packageSelect.selectedIndex];
                const duration = parseInt(selected.dataset.duration);

                const startDate = new Date();
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + duration);

                const preview = document.getElementById('subscription-preview');
                const content = document.getElementById('preview-content');

                content.innerHTML = `
          📦 الباقة: <strong>${packageSelect.value}</strong><br>
          💰 المبلغ: <strong>${formatCurrency(parseFloat(amount), currency)}</strong><br>
          📅 يبدأ من: <strong>${formatDate(startDate.toISOString())}</strong><br>
          📅 ينتهي في: <strong>${formatDate(endDate.toISOString())}</strong><br>
          ⏱️ المدة: <strong>${duration} يوم</strong>
        `;

                preview.style.display = 'block';
            } else {
                document.getElementById('subscription-preview').style.display = 'none';
            }
        }

        // Form submission
        document.getElementById('sales-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const subscriptionData = {
                type: formData.get('type'),
                clientCode: formData.get('clientCode'),
                package: formData.get('package'),
                amount: formData.get('amount'),
                currency: formData.get('currency'),
                paymentMethod: formData.get('paymentMethod')
            };

            // Validate
            if (!subscriptionData.type || !subscriptionData.clientCode || !subscriptionData.package ||
                !subscriptionData.amount || !subscriptionData.currency || !subscriptionData.paymentMethod) {
                showAlert('يرجى ملء جميع الحقول', 'warning');
                return;
            }

            showLoading('جاري تسجيل الاشتراك...');

            setTimeout(() => {
                try {
                    const newSub = db.addSubscription(subscriptionData);
                    const client = db.getClient(subscriptionData.clientCode);

                    hideLoading();
                    showAlert(`تم تسجيل الاشتراك بنجاح للعميل: ${client.fullName}`, 'success');

                    this.reset();
                    document.getElementById('subscription-preview').style.display = 'none';
                    loadRecentSales();

                } catch (error) {
                    hideLoading();
                    showAlert('حدث خطأ: ' + error.message, 'danger');
                }
            }, 500);
        });

        // Load recent sales
        function loadRecentSales() {
            const sales = db.getAllSubscriptions().slice(-5).reverse();
            const container = document.getElementById('recent-sales');

            if (sales.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">لم يتم تسجيل أي مبيعات بعد</p>';
                return;
            }

            container.innerHTML = sales.map(sale => {
                const client = db.getClient(sale.clientCode);
                const status = db.getSubscriptionStatus(sale);

                return `
          <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-md); margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${client ? client.fullName : sale.clientCode}</strong>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                  ${sale.package} • ${formatCurrency(sale.amount, sale.currency)} • ${sale.paymentMethod}
                </div>
              </div>
              <div style="text-align: left;">
                ${getStatusBadge(status)}
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                  ${formatDate(sale.createdAt)}
                </div>
              </div>
            </div>
          </div>
        `;
            }).join('');
        }
    </script>
</body>

</html>