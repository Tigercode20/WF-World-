<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل مبيعات - WF World</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-brand">⚡ WF World</a>
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <ul class="navbar-menu">
                    <li><a href="index.html" class="navbar-link">الرئيسية</a></li>
                    <li><a href="client-registration.html" class="navbar-link">تسجيل عميل</a></li>
                    <li><a href="sales.html" class="navbar-link active">المبيعات</a></li>
                    <li><a href="clients-dashboard.html" class="navbar-link">قائمة العملاء</a></li>
                    <li><a href="client-lookup.html" class="navbar-link">بحث</a></li>
                    <li><a href="settings.html" class="navbar-link">الإعدادات</a></li>
                </ul>
            </div>
    </nav> <button id="theme-toggle-btn" class="theme-toggle" onclick="toggleTheme()" title="تغيير المظهر">☀️</button>
    </div>
    </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: 2rem 0; max-width: 800px;">
        <div class="card">
            <h1>💳 تسجيل اشتراك جديد</h1>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                سجّل اشتراك جديد أو تجديد لعميل موجود
            </p>

            <form id="sales-form">
                <!-- Subscription Type -->
                <div class="form-group">
                    <label for="type" class="form-label">نوع الاشتراك *</label>
                    <select id="type" name="type" class="form-control" required>
                        <option value="">-- اختر --</option>
                        <option value="new">اشتراك جديد</option>
                        <option value="renew">تجديد</option>
                    </select>
                </div>

                <!-- Client Selection -->
                <div class="form-group">
                    <label for="clientCode" class="form-label">كود العميل *</label>
                    <select id="clientCode" name="clientCode" class="form-control" required>
                        <option value="">-- اختر العميل --</option>
                    </select>
                    <small style="color: var(--text-muted); font-size: 0.85rem;">
                        لا تجد العميل؟ <a href="client-registration.html">سجّل عميل جديد</a>
                    </small>
                </div>

                <!-- Client Info Display -->
                <div id="client-info-box" class="alert alert-info" style="display: none; margin-bottom: 1rem;">
                    <strong>📋 بيانات العميل:</strong>
                    <div id="client-info-content" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                </div>

                <!-- Package -->
                <div class="form-group">
                    <label for="package" class="form-label">الباقة *</label>
                    <select id="package" name="package" class="form-control" required>
                        <option value="">-- اختر الباقة --</option>
                    </select>
                    <div id="package-info"
                        style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                        <!-- Package duration info will appear here -->
                    </div>
                </div>

                <!-- Amount -->
                <div class="form-group">
                    <label for="amount" class="form-label">المبلغ *</label>
                    <input type="number" id="amount" name="amount" class="form-control" placeholder="500" min="0"
                        step="0.01" required>
                </div>

                <!-- Currency -->
                <div class="form-group">
                    <label for="currency" class="form-label">العملة *</label>
                    <select id="currency" name="currency" class="form-control" required>
                        <option value="">-- اختر العملة --</option>
                    </select>
                </div>

                <!-- Payment Method -->
                <div class="form-group">
                    <label for="paymentMethod" class="form-label">طريقة الدفع *</label>
                    <select id="paymentMethod" name="paymentMethod" class="form-control" required>
                        <option value="">-- اختر طريقة الدفع --</option>
                    </select>
                </div>

                <!-- Auto-calculated info -->
                <div id="subscription-preview" class="alert alert-info" style="display: none;">
                    <strong>📅 معاينة الاشتراك</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                        <div id="preview-content"></div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-2" style="margin-top: 2rem;">
                    <input type="hidden" id="editingSaleId" value="">
                    <button type="submit" id="submit-btn" class="btn btn-primary">
                        ✅ تسجيل الاشتراك
                    </button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-outline" style="display: none;"
                        onclick="cancelEdit()">
                        ❌ إلغاء التعديل
                    </button>
                    <button type="reset" class="btn btn-outline" onclick="resetForm()">
                        🔄 مسح الحقول
                    </button>
                    <a href="index.html" class="btn btn-outline">
                        ↩️ العودة للرئيسية
                    </a>
                </div>
            </form>
        </div>

        <!-- Recent Sales -->
        <div class="card mt-4">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">💰 آخر المبيعات</h3>
                <button id="sync-sales-btn" class="btn btn-primary" style="font-size: 0.85rem;" onclick="syncSales()">
                    🔄 مزامنة من Google Sheets
                </button>
            </div>
            <div id="recent-sales">
                <!-- Will be loaded dynamically -->
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // Store all loaded sales for edit/delete
        let loadedSales = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function () {
            await loadClients();
            await loadPackages();
            loadRecentSales();
        });

        // Store loaded clients for auto-fill
        let allClients = [];

        // Load clients into dropdown
        async function loadClients() {
            try {
                allClients = await db.getAllClients();
                const select = document.getElementById('clientCode');
                select.innerHTML = '<option value="">-- اختر العميل --</option>';

                allClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.clientCode;
                    option.textContent = `${client.fullName} (${client.clientCode})`;
                    select.appendChild(option);
                });

                // Add change event listener
                select.addEventListener('change', showClientInfo);
            } catch (e) {
                console.error('Error loading clients:', e);
            }
        }

        // Show client info when code is selected
        function showClientInfo() {
            const clientCode = document.getElementById('clientCode').value;
            const infoBox = document.getElementById('client-info-box');
            const infoContent = document.getElementById('client-info-content');

            if (!clientCode) {
                infoBox.style.display = 'none';
                return;
            }

            const client = allClients.find(c => String(c.clientCode) === String(clientCode));

            if (client) {
                infoBox.style.display = 'block';
                infoContent.innerHTML = `
                    <div>👤 <strong>الاسم:</strong> ${client.fullName || '-'}</div>
                    <div>📧 <strong>البريد:</strong> ${client.email || '-'}</div>
                    <div>📱 <strong>الهاتف:</strong> ${client.phone || '-'}</div>
                    <div>🌍 <strong>الدولة:</strong> ${client.country || '-'}</div>
                `;
            } else {
                infoBox.style.display = 'block';
                infoBox.style.borderColor = '#ff5252';
                infoContent.innerHTML = '<span style="color: #ff5252;">⚠️ هذا الكود غير موجود في قائمة العملاء!</span>';
            }
        }

        // Load packages
        async function loadPackages() {
            try {
                const select = document.getElementById('package');
                select.innerHTML = `
                    <option value="">-- اختر الباقة --</option>
                    <option value="Gold" data-duration="90">Gold (3 شهور)</option>
                    <option value="Wafarly" data-duration="30">Wafarly (شهر)</option>
                    <option value="VIP" data-duration="180">VIP (6 شهور)</option>
                `;

                // Load currencies
                const currencySelect = document.getElementById('currency');
                currencySelect.innerHTML = `
                    <option value="">-- اختر --</option>
                    <option value="EGP">جنيه مصري (EGP)</option>
                    <option value="USD">دولار (USD)</option>
                    <option value="SAR">ريال سعودي (SAR)</option>
                    <option value="AED">درهم إماراتي (AED)</option>
                `;

                // Load payment methods
                const paymentSelect = document.getElementById('paymentMethod');
                paymentSelect.innerHTML = `
                    <option value="">-- اختر --</option>
                    <option value="Vodafone Cash">Vodafone Cash</option>
                    <option value="InstaPay">InstaPay</option>
                    <option value="Bank Transfer">تحويل بنكي</option>
                    <option value="Cash">نقدي</option>
                `;
            } catch (e) {
                console.error('Error loading packages:', e);
            }
        }

        // Show package info
        document.getElementById('package').addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            const duration = selected.dataset.duration;
            const info = document.getElementById('package-info');

            if (duration) {
                info.innerHTML = `⏱️ المدة: ${duration} يوم`;
                updatePreview();
            } else {
                info.innerHTML = '';
            }
        });

        // Update preview when fields change
        ['package', 'amount', 'currency'].forEach(id => {
            document.getElementById(id).addEventListener('change', updatePreview);
        });

        function updatePreview() {
            const packageSelect = document.getElementById('package');
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;

            if (packageSelect.value && amount && currency) {
                const selected = packageSelect.options[packageSelect.selectedIndex];
                const duration = parseInt(selected.dataset.duration || 30);

                const startDate = new Date();
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + duration);

                const preview = document.getElementById('subscription-preview');
                const content = document.getElementById('preview-content');

                content.innerHTML = `
          📦 الباقة: <strong>${packageSelect.value}</strong><br>
          💰 المبلغ: <strong>${amount} ${currency}</strong><br>
          📅 يبدأ من: <strong>${startDate.toLocaleDateString('ar-EG')}</strong><br>
          📅 ينتهي في: <strong>${endDate.toLocaleDateString('ar-EG')}</strong><br>
          ⏱️ المدة: <strong>${duration} يوم</strong>
        `;

                preview.style.display = 'block';
            } else {
                document.getElementById('subscription-preview').style.display = 'none';
            }
        }

        // Form submission
        document.getElementById('sales-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const packageSelect = document.getElementById('package');
            const selected = packageSelect.options[packageSelect.selectedIndex];
            const duration = parseInt(selected.dataset.duration || 30);

            const startDate = new Date();
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + duration);

            const subscriptionData = {
                subscriptionType: formData.get('type'),
                clientCode: formData.get('clientCode'),
                package: formData.get('package'),
                amount: parseFloat(formData.get('amount')),
                currency: formData.get('currency'),
                receiveAccount: formData.get('paymentMethod'),
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString(),
                duration: duration,
                createdAt: new Date().toISOString()
            };

            // Validate
            if (!subscriptionData.subscriptionType || !subscriptionData.clientCode || !subscriptionData.package ||
                !subscriptionData.amount || !subscriptionData.currency || !subscriptionData.receiveAccount) {
                showAlert('يرجى ملء جميع الحقول', 'warning');
                return;
            }

            try {
                const client = await db.getClient(subscriptionData.clientCode);
                subscriptionData.clientName = client ? client.fullName : '';
                subscriptionData.email = client ? client.email : '';
                subscriptionData.phone = client ? client.phone : '';

                const editingSaleId = document.getElementById('editingSaleId').value;

                if (editingSaleId) {
                    // UPDATE existing subscription - mark as manually edited
                    subscriptionData.manuallyEdited = true;
                    subscriptionData.lastEditedAt = new Date().toISOString();
                    await db.subscriptionsCol.doc(editingSaleId).update(subscriptionData);
                    showAlert(`تم تعديل الاشتراك بنجاح للعميل: ${subscriptionData.clientName || subscriptionData.clientCode}`, 'success');
                } else {
                    // ADD new subscription
                    await db.addSubscription(subscriptionData);
                    showAlert(`تم تسجيل الاشتراك بنجاح للعميل: ${subscriptionData.clientName || subscriptionData.clientCode}`, 'success');
                }

                // Reset form and edit mode
                this.reset();
                document.getElementById('editingSaleId').value = '';
                document.getElementById('submit-btn').innerHTML = '✅ تسجيل الاشتراك';
                document.getElementById('submit-btn').style.background = '';
                document.getElementById('cancel-edit-btn').style.display = 'none';
                document.getElementById('subscription-preview').style.display = 'none';
                document.getElementById('client-info-box').style.display = 'none';
                loadRecentSales();

            } catch (error) {
                showAlert('حدث خطأ: ' + error.message, 'danger');
            }
        });

        // Load recent sales
        async function loadRecentSales() {
            const container = document.getElementById('recent-sales');
            container.innerHTML = '<p style="color: var(--text-muted);">جاري التحميل...</p>';

            try {
                const sales = await db.getAllSubscriptions();
                const clients = await db.getAllClients();
                const clientCodes = new Set(clients.map(c => String(c.clientCode)));

                const recentSales = sales.slice(-15).reverse();
                loadedSales = recentSales; // Store for edit/delete
                console.log('Loaded sales with IDs:', recentSales.map(s => s.id));

                if (recentSales.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">لم يتم تسجيل أي مبيعات بعد</p>';
                    return;
                }

                container.innerHTML = recentSales.map(sale => {
                    const endDate = sale.endDate ? new Date(sale.endDate) : null;
                    const isActive = endDate ? endDate > new Date() : false;
                    const statusBadge = isActive
                        ? '<span style="color: #00c853; font-weight: 600;">● نشط</span>'
                        : '<span style="color: #ff5252; font-weight: 600;">● منتهي</span>';

                    // Check if client exists
                    const clientExists = clientCodes.has(String(sale.clientCode));
                    const errorBadge = !clientExists
                        ? '<span style="background: #ff5252; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 8px;">⚠️ عميل غير موجود</span>'
                        : '';

                    return `
          <div style="padding: 0.75rem; background: var(--bg-glass); border-radius: var(--radius-md); margin-bottom: 0.5rem; ${!clientExists ? 'border-left: 3px solid #ff5252;' : ''}">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
              <div style="flex: 1;">
                ${errorBadge}
                <strong>${sale.clientName || sale.clientCode}</strong>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                  ${sale.package || 'باقة'} • ${sale.amount || 0} ${sale.currency || 'EGP'} • ${sale.receiveAccount || ''}
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="text-align: center;">
                  ${statusBadge}
                  <div style="font-size: 0.75rem; color: var(--text-muted);">
                    ${sale.startDate ? new Date(sale.startDate).toLocaleDateString('ar-EG') : ''}
                  </div>
                </div>
                <button onclick="editSale('${sale.id}')" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                  ✏️
                </button>
                <button onclick="deleteSale('${sale.id}', '${sale.clientName || sale.clientCode}')" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: #ff5252; border-color: #ff5252;">
                  🗑️
                </button>
              </div>
            </div>
          </div>
        `;
                }).join('');
            } catch (e) {
                console.error('Error loading sales:', e);
                container.innerHTML = '<p style="color: var(--text-muted);">فشل تحميل المبيعات</p>';
            }
        }

        // Delete sale
        async function deleteSale(saleId, clientName) {
            if (!saleId) {
                showAlert('خطأ: لا يوجد معرف للاشتراك', 'danger');
                return;
            }
            if (!confirm(`هل تريد حذف هذا الاشتراك للعميل "${clientName}"؟`)) return;

            try {
                await db.subscriptionsCol.doc(saleId).delete();
                showAlert('تم حذف الاشتراك بنجاح', 'success');
                loadRecentSales();
            } catch (e) {
                showAlert('فشل الحذف: ' + e.message, 'danger');
            }
        }

        // Edit sale - populate form with sale data
        async function editSale(saleId) {
            console.log('Editing sale with ID:', saleId);

            if (!saleId || saleId === 'undefined') {
                showAlert('خطأ: لا يوجد معرف للاشتراك', 'danger');
                return;
            }

            try {
                // Find in loaded sales first (faster)
                let sale = loadedSales.find(s => s.id === saleId);

                if (!sale) {
                    // Fallback to Firestore
                    const doc = await db.subscriptionsCol.doc(saleId).get();
                    if (!doc.exists) {
                        showAlert('لم يتم العثور على الاشتراك', 'warning');
                        return;
                    }
                    sale = { id: doc.id, ...doc.data() };
                }

                console.log('Sale data:', sale);

                // Set editing mode
                document.getElementById('editingSaleId').value = saleId;
                document.getElementById('submit-btn').innerHTML = '✏️ تعديل الاشتراك';
                document.getElementById('submit-btn').style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
                document.getElementById('cancel-edit-btn').style.display = 'inline-block';

                // Fill form with sale data
                document.getElementById('type').value = sale.subscriptionType || 'renew';
                document.getElementById('clientCode').value = sale.clientCode || '';
                document.getElementById('package').value = sale.package || '';
                document.getElementById('amount').value = sale.amount || '';
                document.getElementById('currency').value = sale.currency || 'EGP';
                document.getElementById('paymentMethod').value = sale.receiveAccount || '';

                // Trigger client info display
                showClientInfo();

                // Scroll to form
                document.getElementById('sales-form').scrollIntoView({ behavior: 'smooth' });

                showAlert('تم تحميل بيانات الاشتراك - عدّل ما تريد ثم اضغط "تعديل الاشتراك"', 'info');
            } catch (e) {
                console.error('Edit error:', e);
                showAlert('فشل تحميل البيانات: ' + e.message, 'danger');
            }
        }

        // Cancel edit mode
        function cancelEdit() {
            document.getElementById('editingSaleId').value = '';
            document.getElementById('submit-btn').innerHTML = '✅ تسجيل الاشتراك';
            document.getElementById('submit-btn').style.background = '';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('sales-form').reset();
            document.getElementById('client-info-box').style.display = 'none';
            showAlert('تم إلغاء التعديل', 'info');
        }

        // Reset form
        function resetForm() {
            document.getElementById('editingSaleId').value = '';
            document.getElementById('submit-btn').innerHTML = '✅ تسجيل الاشتراك';
            document.getElementById('submit-btn').style.background = '';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('client-info-box').style.display = 'none';
        }

        // Sync sales from Google Sheets
        async function syncSales() {
            const btn = document.getElementById('sync-sales-btn');
            btn.disabled = true;
            btn.innerHTML = '⏳ جاري المزامنة...';

            try {
                const result = await db.syncSalesFromGoogleSheets();
                showAlert(result.message, 'success');
                await loadRecentSales();
            } catch (error) {
                showAlert('فشلت المزامنة: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '🔄 مزامنة من Google Sheets';
            }
        }
    </script>
</body>

</html>